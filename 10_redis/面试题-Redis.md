# 面试题-Redis

#### Redis 是 AP 的还是 CP 的？

Redis是一个开源的内存数据库，那么他到底是 AP 的还是 CP 的呢？

有人说：单机的 Redis 是 CP 的，而集群的 Redis 是 AP 的？

但是我不这么认为，我觉得 Redis 就是 AP 的，虽然在单机 Redis 中，因为只有一个实例，他的一致性是有保障的，而一旦这个节点挂了，那么就没有可用性可言了。这么看上去好像是个 CP 系统。

但是，CAP 是分布式场景中的理论，如果单机 Redis，那就没啥分布式可言了。P 都没有了，还谈什么 AP、CP 呢？

> 那么，我们来说说，为啥Redis是AP的呢？

Redis 的设计目标是高性能、高可扩展性和高可用性，Redis的一致性模型是最终一致性，即在某个时间点读取的数据可能并不是最新的，但最终会达到一致的状态。

Redis 没办法保证强一致性的主要原因是，因为它的分布式设计中采用的是异步复制，这导致在节点之间存在数据同步延迟和不一致的可能性。

也就是说，当某个节点上的数据发生改变时，Redis 会将这个修改操作发送给其他节点进行同步，但由于网络传输的延迟等原因，这些操作不一定会立即被其他节点接收到和执行，这就可能导致节点之间存在数据不一致的情况。

除此之外，Redis的一致性还受到了节点故障的影响。当一个节点宕机时，这个节点上的数据可能无法同步到其他节点，这就可能导致数据在节点之间的不一致。虽然 Redis 通过复制和哨兵等机制可以提高系统的可用性和容错性，但是这些机制并不能完全解决数据一致性问题。

如果用同步复制的方式呢？

会不会就是 CP 了呢？并不会，这一点在 Redis 的官网中自己明确的说了：

> 客户端可以使用 WAIT 命令请求对特定数据进行同步复制。然而，WAIT 仅能确保数据在 Redis 实例中有指定数量的副本中被确认，它并不能将一组 Redis 实例转变为具有强一致性的 CP 系统：在故障转移期间，已确认的写操作仍然可能会丢失，这取决于 Redis 持久化的具体配置。然而，使用 WAIT 后，在发生故障事件时丢失写操作的概率大大降低，只在某些难以触发的故障模式下才会发生。



#### 介绍一下 Redis 的集群模式？

Redis 有三种主要的集群模式，用于在分布式环境中实现高可用性和数据复制。这些集群模式分别是：主从复制（Master-Slave Replication）、哨兵模式（Sentinel）和 Redis Cluster 模式。



**主从模式**



主从复制是 Redis 最简单的集群模式。这个模式主要是为了解决单点故障的问题，所以将数据复制多个副本中，这样即使有一台服务器出现故障，其他服务器依然可以继续提供服务。

主从模式中，包括一个主节点（Master）和一个或多个从节点（Slave）。主节点负责处理所有写操作和读操作，而从节点则复制主节点的数据，并且只能处理读操作。当主节点发生故障时，可以将一个从节点升级为主节点，实现故障转移（需要手动实现）。

![主从模式-1](./images/主从模式-1.png)

**主从复制的优势在于简单易用，适用于读多写少的场景**。它提供了数据备份功能，并且可以有很好的扩展性，只要增加更多的从节点，就能让整个集群的读的能力不断提升。

但是主从模式最大的缺点，就是不具备故障自动转移的能力，没有办法做容错和恢复。

主节点和从节点的宕机都会导致客户端部分读写请求失败，需要人工介入让节点恢复或者手动切换一台从节点服务器变成主节点服务器才可以。并且在主节点宕机时，如果数据没有及时复制到从节点，也会导致数据不一致。

![主从模式-2](./images/主从模式-2.png)

**哨兵模式**



为了解决主从模式的无法自动容错及恢复的问题，Redis 引入了一种哨兵模式的集群架构。

哨兵模式是在主从复制的基础上加入了哨兵节点。哨兵节点是一种特殊的 Redis 节点，用于监控主节点和从节点的状态。当主节点发生故障时，哨兵节点可以自动进行故障转移，选择一个合适的从节点升级为主节点，并通知其他从节点和应用程序进行更新。

![哨兵模式](./images/哨兵模式.png)

在原来的主从架构中，引入哨兵节点，其作用是监控 Redis 主节点和从节点的状态。每个 Redis 实例都可以作为哨兵节点，通常需要部署多个哨兵节点，以确保故障转移的可靠性。

哨兵节点定期向所有主节点和从节点发送 **PING** 命令，如果在指定的时间内未收到 **PONG** 响应，哨兵节点会将该节点标记为主观下线。如果一个主节点被多数哨兵节点标记为**主观下线**，那么它将被标记为**客观下线**。

当主节点被标记为**客观下线**时，哨兵节点会触发故障转移过程。它会从所有健康的从节点中选举一个新的主节点，并将所有从节点切换到新的主节点，实现自动故障转移。同时，哨兵节点会更新所有客户端的配置，指向新的主节点。

哨兵节点通过发布订阅功能来通知客户端有关主节点状态变化的消息。客户端收到消息后，会更新配置，将新的主节点信息应用于连接池，从而使客户端可以继续与新的主节点进行交互。

这个集群模式的优点就是为整个集群系统了一种故障转移和恢复的能力。



**Cluster 模式**



Redis Cluster 是 Redis 中推荐的分布式集群解决方案。它将数据**自动分片**到多个节点上，每个节点负责一部分数据。 

![Cluster模式](./images/Cluster模式.png)

Redis Cluster 采用主从复制模式来提高可用性。每个分片都有一个主节点和多个从节点。主节点负责处理写操作，而从节点负责复制主节点的数据并处理读请求。

Redis Cluster 能够自动检测节点的故障。当一个节点失去连接或不可达时，Redis Cluster 会尝试将该节点标记为不可用，并从可用的从节点中提升一个新的主节点。

Redis Cluster 是适用于大规模应用的解决方案，它提供了更好的横向扩展和容错能力。它自动管理数据分片和故障转移，减少了运维的负担。

Cluster 模式的特点是数据分片存储在不同的节点上，每个节点都可以单独对外提供读写服务。不存在单点故障的问题。

#### 什么是 Redis 的数据分片？



#### Redis 使用什么协议进行通信？

#### Redis 与 Memcached 有什么区别？

#### Redis 为什么这么快？

#### Redis 支持哪几种数据类型？

#### Redis 为什么要自己定义 SDS？

#### Redis 中的 Zset 是怎么实现的？

#### 什么是 GEO，有什么用？

#### Redis 为什么被设计成是单线程的？

#### 为什么 Redis 设计成单线程也能这么快？

#### 为什么 Redis 6.0 引入了多线程？

#### 为什么 Lua 脚本可以保证原子性？

#### Redis 中的 setnx 命令为什么是原子性的?

#### Redis 5.0 中的 Stream 是什么？

#### Redis 的虚拟内存机制是什么？

#### Redis 的持久化机制是怎样的？

#### Redis 的事务机制是怎样的？

#### Redis 的过期策略是怎么样的？

#### Redis 的内存淘汰策略是怎么样的？

#### 什么是热 Key 问题，如何解决热 key 问题

#### 什么是大 Key 问题，如何解决？

#### 什么是缓存击穿、缓存穿透、缓存雪崩？

#### 什么情况下会出现数据库和缓存不一致的问题？

#### 如何解决 Redis 和数据库的一致性问题？

#### Redis 如何实现延迟消息？

#### Redis 如何实现发布/订阅？

#### 除了做缓存，Redis 还能用来干什么？

#### 对于 Redis 的操作，有哪些推荐的 Best Practices？

#### 如何用 SETNX 实现分布式锁？

#### 什么是 RedLock，他解决了什么问题？

#### 如何用 Redisson 实现分布式锁？

#### 为什么 ZSet 既能支持高效的范围查询，还能以 O(1) 复杂度获取元素权重值？

#### Redisson 的 watch dog 机制是怎么样的？

#### 什么是 Redis 的渐进式 rehash

#### Redis 中 key 过期了一定会立即删除吗?

#### Redis 中有一批 key 瞬间过期，为什么其它 key 的读写效率会降低？

#### 如何基于 Redis 实现滑动窗口限流？

#### 如何基于 Redisson 实现一个延迟队列

#### 介绍下 Redis 集群的脑裂问题？

#### 为什么需要延迟双删，两次删除的原因是什么？

#### Redis 的 Key 和 Value 的设计原则有哪些？

#### Redisson 和 Jedis 有啥区别？如何选择？

#### 什么是 Redis 的 Pipeline，和事务有什么区别？

#### Redis 的事务和 Lua 之间有哪些区别？

#### Redisson 的 lock 和 tryLock 有什么区别？

#### 为什么 Redis 不支持回滚？

#### 如何用 Redis 实现乐观锁？

#### watch dog 一直续期，那客户端挂了怎么办？

#### 如何用 setnx 实现一个可重入锁？

#### Redis 实现分布锁的时候，哪些问题需要考虑？

#### Redis 如何高效安全的遍历所有 key ?

#### watch dog 解锁失败，会不会导致一直续期下去？

#### Redis Cluster 中使用事务和 lua 有什么限制？

#### 如何在 Redis Cluster 中执行 lua 脚本？

#### Redisson 中为什么要废弃 RedLock，该用啥？
